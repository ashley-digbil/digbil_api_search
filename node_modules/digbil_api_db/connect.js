'use strict';
var mongoose = require('mongoose');
var Promise = require('bluebird');

module.exports = function connect(url, options, logger) {
    return new Promise(function(resolve, reject) {
        logger.info('Loading mongoose models');
        var collections = require('./mongo/collections');
        try {
            collections.map(function(name) {
                return name.toLowerCase();
            }).forEach(function(name) {
                var schema = require('./mongo/schemas/'+name);
                var collection = schema.load(mongoose);
                mongoose.model(name, collection, name);
            });

            mongoose.get_collection = function(name) {
                return mongoose.models[name.toLowerCase()];
            };

            logger.info('Connecting to database');

            var db = mongoose.connect(url, options);
            mongoose.connection.once('open', function() {
                logger.info('Connection to db established');
                resolve(db);
            });
        } catch(err) {
            logger.error('Couldn\'t load a collection', err);
            process.nextTick(function() { reject(err); });
        }
    });
}
