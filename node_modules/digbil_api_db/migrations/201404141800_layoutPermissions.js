// This migration adds the layout privileges to roles
// and the corresponding permissions in database.
//
// to run this:
// `nvm use 0.11 && node --harmony layoutPermission.js` dev
// (replace dev with the desired environment)
'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let Roles = db.get_collection('roles');
    let Permissions = db.get_collection('permissions');

    let roles = yield Roles.find().exec();

    let addPrivileges = yield roles.map(Promise.coroutine(function* (role) {
        if(!role.privileges || !role.privileges.length) return;
        let layoutPrivilege = _.find(role.privileges, function(p) {
            return p.function === 'Layouts';
        });

        if(layoutPrivilege) return

        let playerPrivilege = _.find(role.privileges, function(p) {
            return p.function === 'Players';
        });

        if(!playerPrivilege) {
            console.log('no Players privilege for role: ', role);
            return
        }

        // layout privilege will be the same as the player privilege
        playerPrivilege = playerPrivilege.toObject();
        let newPrivilege = _.assign({
            function: 'Layouts'
        }, _.omit(playerPrivilege, 'function', 'groups'));

        console.log('adding new layout privilege for role %s', role._id);
        role.privileges.push(newPrivilege);
        role.markModified('privileges');
        return Promise.promisify(role.save, role)();
    }));

    console.log('all roles have been updated');

    let playerPermissions = yield Permissions.find()
        .where('rtype', 12)
        .exec();

    // for each player permissions, check if there is a corresponding
    // layout permission for the same entity and role. If not, add it

    let addPermissions = yield playerPermissions.map(Promise.coroutine(function* (player) {
        let layoutPerm = yield Permissions.findOne()
            .where('rtype', 2)
            .where('entity', player.entity)
            .where('role', player.role)
            .exec();
        if(layoutPerm) return;

        let newPerm = new Permissions({
            role: player.role,
            rights: player.rights,
            rtype: 2,
            all_doc: player.all_doc,
            entity: player.entity
        });
        console.log('add new permission for layout %s', newPerm._id);
        return Promise.promisify(newPerm.save, newPerm)();
    }));
    console.log('permissions added');
    process.exit(0);
})();
