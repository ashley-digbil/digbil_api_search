'use strict';

var Promise = require('bluebird');
var _ = require('lodash');

module.exports.run = function run(db, logger) {
    var Role = db.get_collection('roles');
    var User = db.get_collection('userprofile');

    // Super admin not changed, do not need any update
    var roles = Promise.cast(
        Role.find().where('name').ne('Super Admin').exec()
    );

    var fixRoleNames = roles.map(function(role) {
        return User.update({
            'entities.role': role._id
        }, {
            'entities.$.role_name': role.name
        }, {
            multi: true
        }).exec();
    })
    .all();

    return fixRoleNames;
}
