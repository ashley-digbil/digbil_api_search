// Default email_notification change to false.
// Set to false for old user data.
// nvm use 0.11 
// node --harmony 2014_0519_turnOffUserNotification.js dev
// (replace dev with the desired environment)
'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let UserColl = db.get_collection('userprofile');

    let users = yield UserColl.find().exec();

    yield users.map(Promise.coroutine(function* (user) {
        if(!user.settings || !user.settings.email_notifications){
            return;
        }

        user.settings.email_notifications.camp_warning = false;
        user.settings.email_notifications.camp_status = false;
        user.settings.email_notifications.media_status = false;
        user.settings.email_notifications.ds_status = false;

        console.log('turn off user notification : %s', user.fn);

        return Promise.promisify(user.save, user)();

    }));

    console.log('Finish turn off user notification');
    process.exit(0);
})();
