// Entity add contact_name to record user name.
// Copy user first name to contact_name for old entity data.
// nvm use 0.11 
// node --harmony 2014_0519_transferEntityContactName.js dev
// (replace dev with the desired environment)
'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let EntitiesColl = db.get_collection('entities');
    let UserColl = db.get_collection('userprofile');

    let entities = yield EntitiesColl.find().exec();

    yield entities.map(Promise.coroutine(function* (entity) {
        if(!entity.user) return;
        let user = yield UserColl.findById(entity.user)
            .exec();
        if(!user) return;
        entity.contact_name = user.fn;
        console.log('set entity %s : contact name : %s', entity.name, entity.contact_name);

        return Promise.promisify(entity.save, entity)();

    }));

    console.log('Finish change entity contact name');
    process.exit(0);
})();
