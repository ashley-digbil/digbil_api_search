// Remove image permission setting from role
// Video / Image / Audio should use Media permission setting
// nvm use 0.11 
// node --harmony 2014_0528_removeImagePermission.js dev
// (replace dev with the desired environment)
'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let Roles = db.get_collection('roles');
    let Permissions = db.get_collection('permissions');

    let roles = yield Roles.find().exec();

    let removePrivileges = yield roles.map(Promise.coroutine(function* (role) {
        if(!role.privileges || !role.privileges.length) return;

        let imagePrivilege = _.find(role.privileges, function(p){
            return p.function === 'Image';
        });
        
        if(!imagePrivilege)
            return;

        let mediaPrivilege = _.filter(role.privileges, function(p){
            return p.function !== 'Image';
        });
        role.privileges = mediaPrivilege;

        console.log('remove image privilege frome role %s', role._id);

        role.markModified('privileges');
        return Promise.promisify(role.save, role)();
    }));

    console.log('all roles have been updated');

    process.exit(0);
})();
