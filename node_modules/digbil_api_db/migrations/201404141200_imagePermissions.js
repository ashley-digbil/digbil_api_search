// This migration adds the image privileges to roles
// and the corresponding permissions in database.
//
// to run this:
// `nvm use 0.11 && node --harmony imagePermission.js` dev
// (replace dev with the desired environment)
'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let Roles = db.get_collection('roles');
    let Permissions = db.get_collection('permissions');

    let roles = yield Roles.find().exec();

    let addPrivileges = yield roles.map(Promise.coroutine(function* (role) {
        if(!role.privileges || !role.privileges.length) return;
        let imagePrivilege = _.find(role.privileges, function(p) {
            return p.function === 'Image';
        });

        if(imagePrivilege) return

        let mediaPrivilege = _.find(role.privileges, function(p) {
            return p.function === 'Media';
        });

        if(!mediaPrivilege) {
            console.log('no media privilege for role: ', role);
            return
        }

        // Image privilege will be the same as the media privilege
        mediaPrivilege = mediaPrivilege.toObject();
        let newPrivilege = _.assign({
            function: 'Image'
        }, _.omit(mediaPrivilege, 'function', 'groups'));

        console.log('adding new image privilege for role %s', role._id);
        role.privileges.push(newPrivilege);
        role.markModified('privileges');
        return Promise.promisify(role.save, role)();
    }));

    console.log('all roles have been updated');

    let mediaPermissions = yield Permissions.find()
        .where('rtype', 3)
        .exec();

    // for each media permissions, check if there is a corresponding
    // image permission for the same entity and role. If not, add it

    let addPermissions = yield mediaPermissions.map(Promise.coroutine(function* (media) {
        let imagePerm = yield Permissions.findOne()
            .where('rtype', 15)
            .where('entity', media.entity)
            .where('role', media.role)
            .exec();
        if(imagePerm) return;

        let newPerm = new Permissions({
            role: media.role,
            rights: media.rights,
            rtype: 15,
            all_doc: media.all_doc,
            entity: media.entity
        });
        console.log('add new permission for image %s', newPerm._id);
        return Promise.promisify(newPerm.save, newPerm)();
    }));
    console.log('permissions added');
    process.exit(0);
})();
