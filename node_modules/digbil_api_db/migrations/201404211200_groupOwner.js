// This migration adds the layout privileges to roles
// and the corresponding permissions in database.
//
// to run this:
// `nvm use 0.11 && node --harmony 201404211200_groupOwner.js` dev
// (replace dev with the desired environment)
'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let Groups = db.get_collection('groups');
    let Permissions = db.get_collection('permissions');

    let groups = yield Groups.find().exec();

    let moveGroupOwner = yield groups.map(Promise.coroutine(function* (group) {
        if(!group || !group.owner){
            console.log("no owner for group: ", group);
            return;
        }
        if(group.user){
            return;
        }
        group.user = group.owner;
        console.log("updating user(owner) for group %s.", group._id);
        return Promise.promisify(group.save, group)();
    }));

    console.log('all group have been updated');
    process.exit(0);
})();
