// this migration remove the privileges 'Image' in all
// roles. The image permission is now linked and handled
// along with the Media role.

'use strict';

let Promise = require('bluebird');
let mongoose = require('mongoose');
let ObjectId = mongoose.Types.ObjectId;
let _ = require('lodash');

var argv = require('minimist')(process.argv.slice(2));
var env = argv._[0] || 'test';
console.log('Migration on environment: '+ env);

Promise.coroutine(function* () {

    let db = yield require('./connect')(env);
    let Roles = db.get_collection('roles');

    let roles = yield Roles.find().exec();

    yield roles.map(Promise.coroutine(function* (role) {
        if(!role.privileges) return;
        role.privileges = role.privileges.filter(function(p) {
            return p.function !== 'Image';
        });
        console.log('removing image privilege from role %s', role._id);
        role.markModified('privileges');
        return Promise.promisify(role.save, role)();
    }));

    console.log('privileges removed');
    process.exit(0);
})();
