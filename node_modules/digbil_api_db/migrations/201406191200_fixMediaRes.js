'use strict';
var Promise = require('bluebird');

// remove the field `res` from the mfiles and
// cast wres and hres to Number (the cast is automatically done
// by the new mongoose schema actually)
module.exports.run = function run(db, logger) {
    var Media = db.get_collection('media');
    var toFix = Promise.cast(Media.find()
    .where('mfiles.0').exists()
    .exec());

    return toFix.map(function(media) {
        media.mfiles.forEach(function(mfile) {
            mfile.res = undefined;
        });
        return Promise.promisify(media.save, media)();
    }).all();

}
